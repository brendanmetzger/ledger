<article class="gradebook">
  <style>
    [a.edit:before {
      content: '$instructor:edit'
    }

    ]
  </style>
  <link rel="stylesheet" href="/css/table.css" />
  <header class="banner">
    <h1 class="tt">[$course:@title ยง$section:@id]</h1>
    <h4><time>[$section:time]</time> <span>[Room $section:@room]</span></h4>
  </header>
  <table class="full chart tt bb">
    <caption>
      <h3 class="rag-left pad b caps spaced">Overview</h3>
    </caption>
    <thead>
      <tr class="rotate">
        <th>index</th>
        <!-- iterate section:students -->
        <th><a href="[/records/student/$student:@id]">[$student:shortname]</a></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>Grade</th>
        <!-- iterate section:students -->
        <td style="[--hue: $student:grade:score; --value: $student:grade:score%;]" class="centered">[$student:grade:letter]</td>
      </tr>
      <tr>
        <th>Score</th>
        <!-- iterate section:students -->
        <td class="centered percentage">[$student:grade:score]</td>
      </tr>
      <tr>
        <th>absences</th>
        <!-- iterate section:students -->
        <td class="centered">todo</td>
      </tr>
    </tbody>
  </table>

  <table class="full chart tt bb">
    <caption>
      <h3 class="rag-left pad b caps spaced">Attendance</h3>
    </caption>
    <thead>
      <tr class="rotate">
        <th>Week</th>
        <!-- iterate section:students -->
        <th><a href="[/records/student/$student:@id]">[$student:shortname]</a></th>
      </tr>
    </thead>
    <tbody>
      <!-- iterate records:discourse -->
      <tr class="[$criterion:status]">
        <th class="_"><time datetime="[$due:datetime]">[$due:date]</time></th>
        <!-- iterate records -->
        <td class="[centered marked $assessment:schedule:status]" title="[$assessment:discourse:letter]">
          <a class="quick edit" href="[[/records/evaluate/discourse/$$criterion:@index/$student:@id]]">[$assessment:discourse:flag]</a>
        </td>
      </tr>
    </tbody>
  </table>
  <table class="full chart tt bb">
    <caption>
      <h3 class="rag-left pad b caps spaced">Practice</h3>
    </caption>
    <thead>
      <tr class="rotate">
        <th>Assignment</th>
        <!-- iterate section:students -->
        <th><a href="[/records/student/$student:@id]">[$student:shortname]</a></th>
      </tr>
    </thead>
    <tbody>
      <!-- iterate records:practice -->
      <tr class="[$criterion:status]">
        <th><a href="[[/records/book/$$section:@course/$$section:@id/practice/$criterion:@index]]">[$title]</a></th>
        <!-- iterate records -->
        <td class="[centered marked $assessment:schedule:status]" style="[--hue: $assessment:practice:percentage; --value: $assessment:practice:percentage%;]" title="[$assessment:practice:letter]">
          <a class="percentage edit" href="[[/records/evaluate/practice/$$criterion:@index/$student:@id]]">[$assessment:practice:percentage]</a>
        </td>
      </tr>
    </tbody>
  </table>
  <table class="full chart tt bb">
    <caption>
      <h3 class="rag-left pad b caps spaced">Quizzes</h3>
    </caption>
    <thead>
      <tr class="rotate">
        <th>Exam</th>
        <!-- iterate section:students -->
        <th><a href="[/records/student/$student:@id]">[$student:shortname]</a></th>
      </tr>
    </thead>
    <tbody>
      <!-- iterate records:quiz -->
      <tr class="[$criterion:status]">
        <th>[$title]</th>
        <!-- iterate records -->
        <td class="[centered marked $assessment:schedule:status]" style="[--hue: $assessment:stats:standard; --value: $assessment:stats:standard%;]" title="[$assessment:quiz:letter]">
          <a class="percentage quick edit" href="[[/records/evaluate/quiz/$$criterion:@index/$student:@id]]">[$assessment:quiz:weighted]</a>
        </td>
      </tr>
    </tbody>
  </table>
  <script type="text/javascript">
    bloc.init('ajax', function() {
      document.querySelector('article.gradebook').addEventListener('click', function(evt) {
        var clicked = evt.target;
        if (clicked.matches("td a.quick")) {
          clicked.style.opacity = 0;
          evt.preventDefault();
          var request = new XMLHttpRequest();
          var DOMoverlay = document.body.appendChild(document.createElement('div'));
          request.open('GET', clicked.href);
          request.addEventListener('load', function(evt) {
            document.body.classList.add('overlay');
            var form = DOMoverlay.appendChild(evt.target.responseXML.querySelector('form[action^="/records/evaluate"]'));
            Array.from(form.querySelectorAll('script')).map(script => script.text).forEach(eval);
            form.addEventListener('submit', function(evt) {
              evt.preventDefault();
              var request = new XMLHttpRequest();
              request.open('POST', this.action);
              request.addEventListener('load', function(evt) {
                var node = evt.target.responseXML.querySelector(`a[href="${clicked.pathname}"]`);
                node.style.opacity = 0;
                var replace = node.parentNode.parentNode.parentNode;
                var original = clicked.parentNode.parentNode.parentNode;
                original.parentNode.replaceChild(replace, original);
                setTimeout(Object.assign.bind(null, node.style, {
                  opacity: 1
                }), 10);
                setTimeout(HTMLElement.prototype.removeChild.bind(DOMoverlay.parentNode, DOMoverlay), 750);
              });
              document.body.classList.remove('overlay');
              request.send(new FormData(this));
            });
          });
          request.send();
        }
      });
    });
  </script>
  <table class="full chart tt bb">
    <caption>
      <h3 class="rag-left pad b caps spaced">Projects</h3>
    </caption>
    <thead>
      <tr class="rotate">
        <th>Assignment</th>
        <!-- iterate section:students -->
        <th><a href="[/records/student/$student:@id]">[$student:shortname]</a></th>
      </tr>
    </thead>
    <tbody>
      <!-- iterate records:project -->
      <tr class="[$criterion:status]">
        <th>[$title]</th>
        <!-- iterate records -->
        <td class="[centered marked $assessment:schedule:status]" title="[$assessment:project:letter]">
          <a class="percentage edit" href="[[/records/evaluate/project/$$criterion:@index/$student:@id]]">[$assessment:project:percentage]</a>
        </td>
      </tr>
    </tbody>
  </table>
  <footer class="tt bb">
    <h3><a href="/records/courses">Back to courses</a></h3>
  </footer>
</article>
